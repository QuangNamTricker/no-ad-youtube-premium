<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>No Ad YouTube Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff0000;
            --secondary-color: #ff4d4d;
            --dark-bg: #0f0f0f;
            --dark-secondary: #272727;
            --dark-tertiary: #3d3d3d;
            --light-bg: #f9f9f9;
            --light-secondary: #ffffff;
            --light-tertiary: #eeeeee;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-dark: #0f0f0f;
            --text-gray: #606060;
            --transition-speed: 0.3s;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] {
            --bg-primary: var(--light-bg);
            --bg-secondary: var(--light-secondary);
            --bg-tertiary: var(--light-tertiary);
            --text-primary: var(--text-dark);
            --text-secondary: var(--text-gray);
        }

        [data-theme="dark"] {
            --bg-primary: var(--dark-bg);
            --bg-secondary: var(--dark-secondary);
            --bg-tertiary: var(--dark-tertiary);
            --text-primary: var(--text-primary);
            --text-secondary: var(--text-secondary);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        /* Header Styles */
        header {
            background-color: var(--bg-secondary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform var(--transition-speed);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo h1 {
            font-size: 1.5rem;
            background: linear-gradient(45deg, var(--primary-color), #ff8e8e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        .logo i {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        .search-container {
            flex: 1;
            display: flex;
            max-width: 600px;
            position: relative;
        }

        #searchInput {
            flex: 1;
            padding: 12px 16px;
            border-radius: 30px;
            border: 2px solid var(--bg-tertiary);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-speed);
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2);
        }

        #searchInput::placeholder {
            color: var(--text-secondary);
        }

        #searchButton {
            position: absolute;
            right: 5px;
            top: 5px;
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 7px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        #searchButton:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            cursor: pointer;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-name {
            font-size: 0.9rem;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-btn {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .header-btn:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        /* Navigation */
        .nav-container {
            background-color: var(--bg-secondary);
            padding: 10px 20px;
            overflow-x: auto;
            white-space: nowrap;
            position: sticky;
            top: 64px;
            z-index: 900;
            box-shadow: var(--shadow);
        }

        .nav-tabs {
            display: inline-flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 18px;
            cursor: pointer;
            transition: all var(--transition-speed);
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-tab:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Main Content */
        main {
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        #videoPlayer {
            flex: 1 1 65%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all var(--transition-speed);
        }

        #videoPlayer:hover {
            box-shadow: 0 15px 35px rgba(255, 0, 0, 0.2);
        }

        .player-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            border-radius: 12px;
            overflow: hidden;
        }

        #playerIframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }

        .video-info {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 15px;
        }

        .video-info h2 {
            margin-bottom: 10px;
            font-size: 1.4rem;
        }

        .video-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .action-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        /* Video List */
        #videoList {
            flex: 1 1 30%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 90vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        #videoList::-webkit-scrollbar {
            width: 8px;
        }

        #videoList::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        #videoList::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }

        .videoItem {
            background: var(--bg-secondary);
            padding: 12px;
            cursor: pointer;
            display: flex;
            gap: 12px;
            border-radius: 10px;
            transition: all var(--transition-speed);
            animation: fadeIn 0.5s ease-out;
            position: relative;
            box-shadow: var(--shadow);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .videoItem:hover {
            background: var(--bg-tertiary);
            transform: translateX(5px);
        }

        .videoItem img {
            width: 160px;
            height: 90px;
            border-radius: 6px;
            object-fit: cover;
            transition: all var(--transition-speed);
        }

        .videoItem:hover img {
            transform: scale(1.05);
        }

        .videoInfo {
            flex: 1;
        }

        .videoInfo h4 {
            font-size: 0.95rem;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .videoInfo p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .favorite-btn:hover {
            color: var(--primary-color);
            transform: scale(1.2);
        }

        .favorite-btn.active {
            color: var(--primary-color);
        }

        /* Loading Animation */
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loader .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all var(--transition-speed);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast i {
            color: var(--primary-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-speed);
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: translateY(-50px);
            transition: transform var(--transition-speed);
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Login Required Overlay */
        .login-required {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            text-align: center;
        }

        .login-required-content {
            max-width: 500px;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .login-required h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .login-required p {
            margin-bottom: 25px;
            color: var(--text-secondary);
        }

        .login-btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 500;
            transition: all var(--transition-speed);
        }

        .login-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            main {
                flex-direction: column;
            }
            
            #videoPlayer, #videoList {
                flex: 1 1 100%;
            }
            
            #videoList {
                max-height: none;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-between;
            }
            
            .videoItem {
                flex: 0 0 48%;
            }
        }

        @media (max-width: 768px) {
            header {
                flex-wrap: wrap;
            }
            
            .search-container {
                order: 3;
                flex: 1 1 100%;
                margin-top: 10px;
            }
            
            .videoItem {
                flex: 0 0 100%;
            }
            
            .video-actions {
                justify-content: center;
            }
            
            .user-name {
                display: none;
            }
        }

        /* Footer */
        footer {
            background: var(--bg-secondary);
            padding: 20px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
        }

        .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color var(--transition-speed);
        }

        .footer-link:hover {
            color: var(--primary-color);
        }

        /* Theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle-checkbox {
            display: none;
        }

        .theme-toggle-label {
            display: block;
            width: 60px;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background var(--transition-speed);
        }

        .theme-toggle-label:after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border-radius: 50%;
            transition: transform var(--transition-speed);
        }

        .theme-toggle-checkbox:checked + .theme-toggle-label:after {
            transform: translateX(30px);
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Overlay yêu cầu đăng nhập (sẽ ẩn khi đã đăng nhập) -->
    <div id="loginRequired" class="login-required">
        <div class="login-required-content">
            <h2><i class="fab fa-youtube"></i> No Ad YouTube Premium</h2>
            <p>Vui lòng đăng nhập để sử dụng ứng dụng và đồng bộ dữ liệu trên nhiều thiết bị</p>
            <a href="login.html" class="login-btn">Đăng nhập ngay</a>
        </div>
    </div>

    <!-- Giao diện chính (sẽ hiển thị khi đã đăng nhập) -->
    <div id="mainContent" style="display: none;">
        <header>
            <div class="logo" onclick="location.reload()">
                <i class="fab fa-youtube"></i>
                <h1>No Ad YT Premium</h1>
            </div>
            
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Tìm kiếm video không quảng cáo..." />
                <button id="searchButton" onclick="searchVideos()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="header-buttons">
                <div class="theme-toggle">
                    <input type="checkbox" id="themeToggle" class="theme-toggle-checkbox" onchange="toggleTheme()">
                    <label for="themeToggle" class="theme-toggle-label"></label>
                </div>
                <div class="user-info" onclick="showUserMenu()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-name" id="userName">User</div>
                </div>
                <button class="header-btn" title="Lịch sử" onclick="showHistory()">
                    <i class="fas fa-history"></i>
                </button>
                <button class="header-btn" title="Yêu thích" onclick="showFavorites()">
                    <i class="fas fa-heart"></i>
                </button>
                <button class="header-btn" title="Cài đặt" onclick="showSettings()">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn" title="Đăng xuất" onclick="logout()" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div class="nav-container">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="changeCategory('all')">Tất cả</div>
                <div class="nav-tab" onclick="changeCategory('music')">Âm nhạc</div>
                <div class="nav-tab" onclick="changeCategory('game')">Trò chơi</div>
                <div class="nav-tab" onclick="changeCategory('tech')">Công nghệ</div>
                <div class="nav-tab" onclick="changeCategory('edu')">Giáo dục</div>
                <div class="nav-tab" onclick="changeCategory('sport')">Thể thao</div>
            </div>
        </div>

        <main>
            <section id="videoPlayer">
                <div class="player-container">
                    <iframe id="playerIframe" src="about:blank" allowfullscreen></iframe>
                </div>
                <div class="video-info">
                    <h2 id="videoTitle">Chọn một video để phát</h2>
                    <p id="videoDescription"></p>
                    <div class="video-actions">
                        <button class="action-btn" onclick="likeVideo()">
                            <i class="fas fa-thumbs-up"></i> Thích
                        </button>
                        <button class="action-btn" onclick="addToFavorites()">
                            <i class="fas fa-heart"></i> Yêu thích
                        </button>
                        <button class="action-btn" onclick="shareVideo()">
                            <i class="fas fa-share"></i> Chia sẻ
                        </button>
                        <button class="action-btn" onclick="downloadVideo()">
                            <i class="fas fa-download"></i> Tải xuống
                        </button>
                    </div>
                </div>
            </section>
            
            <section id="videoList">
                <h3 class="section-title">Video đề xuất</h3>
                <div class="loader">
                    <div class="spinner"></div>
                    <p>Đang tải video...</p>
                </div>
                <!-- Video items will be inserted here -->
            </section>
        </main>

        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Cài đặt</h3>
                    <button class="close-modal" onclick="closeModal('settingsModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="setting-item">
                        <h4>Chất lượng video</h4>
                        <select id="videoQuality">
                            <option value="auto">Tự động</option>
                            <option value="hd1080">1080p</option>
                            <option value="hd720">720p</option>
                            <option value="medium">480p</option>
                            <option value="small">360p</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <h4>Tốc độ phát</h4>
                        <select id="playbackSpeed">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>Bình thường</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <h4>Chế độ tự động phát</h4>
                        <label class="switch">
                            <input type="checkbox" id="autoplay">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage"></span>
        </div>

        <footer>
            <div class="footer-content">
                <p>No Ad YouTube Premium - Trải nghiệm YouTube không quảng cáo</p>
                <p>© 2025 Từ Quang Nam. Tất cả quyền được bảo lưu.</p>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Cấu hình Firebase - SỬ DỤNG THÔNG TIN CỦA BẠN
        const firebaseConfig = {
            apiKey: "AIzaSyCYFn-as8A7fUa3cBf2O2BEvyDe5FeMEkE",
            authDomain: "no-ad-ytb-premium.firebaseapp.com",
            projectId: "no-ad-ytb-premium",
            storageBucket: "no-ad-ytb-premium.firebasestorage.app",
            messagingSenderId: "596118335749",
            appId: "1:596118335749:web:3493cfa9d554b7260c076c",
            measurementId: "G-WLYYVSELEN"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // API Key YouTube
        const apiKey = "AIzaSyCQLFP6dPYpUUaDisEKdg2MyBs3VUH4pIw";
        
        // Biến toàn cục
        let currentVideoId = null;
        let currentVideoTitle = null;
        let favorites = [];
        let history = [];
        let currentCategory = 'all';
        let userData = null;

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra trạng thái đăng nhập
            checkAuth();
            
            // Thiết lập theme từ localStorage
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').checked = savedTheme === 'light';
            
            // Thêm event listener cho Enter key trong search input
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchVideos();
                }
            });
        });

        // Kiểm tra đăng nhập
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Người dùng đã đăng nhập
                    userData = user;
                    updateUserInfo(user);
                    loadUserData(user.uid);
                    document.getElementById('loginRequired').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    // Người dùng chưa đăng nhập
                    document.getElementById('loginRequired').style.display = 'flex';
                    document.getElementById('mainContent').style.display = 'none';
                }
            });
        }

        // Cập nhật thông tin người dùng
        function updateUserInfo(user) {
            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');
            
            // Lấy chữ cái đầu của email để hiển thị
            const firstLetter = user.email.charAt(0).toUpperCase();
            avatar.textContent = firstLetter;
            
            // Hiển thị tên người dùng
            name.textContent = user.displayName || user.email;
        }

        // Tải dữ liệu người dùng
        function loadUserData(userId) {
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        favorites = data.favorites || [];
                        history = data.history || [];
                        
                        // Cập nhật cài đặt
                        if (data.settings) {
                            document.body.setAttribute('data-theme', data.settings.theme || 'dark');
                            document.getElementById('themeToggle').checked = data.settings.theme === 'light';
                            document.getElementById('autoplay').checked = data.settings.autoplay !== false;
                            document.getElementById('videoQuality').value = data.settings.quality || 'auto';
                        }
                        
                        // Tải video trending
                        loadTrendingVideos();
                        
                        // Hiển thị thông báo chào mừng
                        showToast(`Chào mừng ${data.name || userData.email} trở lại!`);
                    } else {
                        // Nếu chưa có dữ liệu, tạo mới
                        db.collection('users').doc(userId).set({
                            name: userData.displayName || '',
                            email: userData.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            favorites: [],
                            history: [],
                            settings: {
                                theme: 'dark',
                                autoplay: true,
                                quality: 'auto'
                            }
                        }).then(() => {
                            loadTrendingVideos();
                            showToast('Tài khoản đã được tạo thành công!');
                        });
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi tải dữ liệu:', error);
                    showToast('Đã xảy ra lỗi khi tải dữ liệu', 'error');
                });
        }

        // Lưu dữ liệu người dùng
        function saveUserData() {
            if (!userData) return;
            
            db.collection('users').doc(userData.uid).update({
                favorites: favorites,
                history: history,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(error => {
                console.error('Lỗi khi lưu dữ liệu:', error);
            });
        }

        // Đăng xuất
        function logout() {
            auth.signOut().then(() => {
                window.location.reload();
            }).catch(error => {
                console.error('Lỗi khi đăng xuất:', error);
                showToast('Đã xảy ra lỗi khi đăng xuất', 'error');
            });
        }

        // Hàm tải video trending
        function loadTrendingVideos() {
            const loader = document.querySelector('.loader');
            const videoList = document.getElementById('videoList');
            const sectionTitle = videoList.querySelector('.section-title');
            
            sectionTitle.textContent = 'Video đề xuất';
            loader.style.display = 'block';
            videoList.innerHTML = '';
            videoList.appendChild(sectionTitle);
            videoList.appendChild(loader);

            // Sử dụng search API với từ khóa phổ biến
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=15&q=music&key=${apiKey}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    loader.style.display = 'none';
                    
                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            const videoId = item.id.videoId;
                            const title = item.snippet.title;
                            const thumb = item.snippet.thumbnails.medium.url;
                            const channelTitle = item.snippet.channelTitle;
                            
                            const isFavorite = favorites.some(fav => fav.id === videoId);
                            
                            const div = document.createElement('div');
                            div.className = 'videoItem';
                            div.innerHTML = `
                                <img src="${thumb}" alt="${title}" />
                                <div class="videoInfo">
                                    <h4>${title}</h4>
                                    <p>${channelTitle}</p>
                                </div>
                                <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(event, '${videoId}', '${title.replace(/'/g, "\\'")}', '${thumb}')">
                                    <i class="fas fa-heart"></i>
                                </button>
                            `;
                            
                            div.onclick = () => playVideo(videoId, title, item.snippet.description);
                            videoList.appendChild(div);
                        });
                    } else {
                        videoList.innerHTML += '<p>Không tìm thấy video nào.</p>';
                    }
                })
                .catch(error => {
                    loader.style.display = 'none';
                    console.error('Error:', error);
                    showToast('Đã xảy ra lỗi khi tải video. Vui lòng thử lại.', 'error');
                });
        }

        // Hàm tìm kiếm video
        function searchVideos() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showToast('Vui lòng nhập từ khóa tìm kiếm', 'error');
                return;
            }

            const loader = document.querySelector('.loader');
            const videoList = document.getElementById('videoList');
            const sectionTitle = videoList.querySelector('.section-title');
            
            sectionTitle.textContent = `Kết quả tìm kiếm: "${query}"`;
            loader.style.display = 'block';
            videoList.innerHTML = '';
            videoList.appendChild(sectionTitle);
            videoList.appendChild(loader);

            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=15&q=${encodeURIComponent(query)}&key=${apiKey}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    loader.style.display = 'none';
                    
                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            const videoId = item.id.videoId;
                            const title = item.snippet.title;
                            const thumb = item.snippet.thumbnails.medium.url;
                            const channelTitle = item.snippet.channelTitle;
                            
                            const isFavorite = favorites.some(fav => fav.id === videoId);
                            
                            const div = document.createElement('div');
                            div.className = 'videoItem';
                            div.innerHTML = `
                                <img src="${thumb}" alt="${title}" />
                                <div class="videoInfo">
                                    <h4>${title}</h4>
                                    <p>${channelTitle}</p>
                                </div>
                                <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="toggleFavorite(event, '${videoId}', '${title.replace(/'/g, "\\'")}', '${thumb}')">
                                    <i class="fas fa-heart"></i>
                                </button>
                            `;
                            
                            div.onclick = () => playVideo(videoId, title, item.snippet.description);
                            videoList.appendChild(div);
                        });
                        
                        // Thêm vào lịch sử tìm kiếm
                        addToHistory(query);
                    } else {
                        videoList.innerHTML += '<p>Không tìm thấy video nào. Vui lòng thử từ khóa khác.</p>';
                    }
                })
                .catch(error => {
                    loader.style.display = 'none';
                    console.error('Error:', error);
                    showToast('Đã xảy ra lỗi khi tải video. Vui lòng thử lại.', 'error');
                });
        }

        // Hàm phát video
        function playVideo(videoId, title, description) {
            currentVideoId = videoId;
            currentVideoTitle = title;
            
            const player = document.getElementById('playerIframe');
            const quality = document.getElementById('videoQuality').value;
            
            player.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=1`;
            
            document.getElementById('videoTitle').textContent = title;
            document.getElementById('videoDescription').textContent = description || 'Không có mô tả';
            
            // Thêm vào lịch sử xem
            addToHistory(videoId, title, true);
            
            // Cuộn lên đầu trang để xem video
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Thêm vào lịch sử
        function addToHistory(item, title = null, isVideo = false) {
            if (!userData) return;
            
            const timestamp = new Date().toISOString();
            
            if (isVideo) {
                // Thêm video vào lịch sử
                const existingIndex = history.findIndex(h => h.type === 'video' && h.id === item);
                
                if (existingIndex !== -1) {
                    // Nếu đã tồn tại, xóa và thêm lại ở đầu
                    history.splice(existingIndex, 1);
                }
                
                history.unshift({
                    type: 'video',
                    id: item,
                    title: title,
                    timestamp: timestamp
                });
            } else {
                // Thêm tìm kiếm vào lịch sử
                history.unshift({
                    type: 'search',
                    query: item,
                    timestamp: timestamp
                });
            }
            
            // Giới hạn lịch sử tối đa 50 mục
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            
            // Lưu dữ liệu
            saveUserData();
        }

        // Chuyển đổi danh mục
        function changeCategory(category) {
            currentCategory = category;
            
            // Cập nhật tab active
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Tìm kiếm theo danh mục
            const categoryKeywords = {
                'music': 'âm nhạc nhạc mv official',
                'game': 'game gameplay trò chơi',
                'tech': 'công nghệ technology review',
                'edu': 'giáo dục học tập education',
                'sport': 'thể thao sport bóng đá'
            };
            
            if (category === 'all') {
                loadTrendingVideos();
            } else {
                document.getElementById('searchInput').value = categoryKeywords[category];
                searchVideos();
            }
        }

        // Hiển thị lịch sử
        function showHistory() {
            const videoList = document.getElementById('videoList');
            videoList.innerHTML = '<h3 class="section-title">Lịch sử</h3>';
            
            if (history.length === 0) {
                videoList.innerHTML += '<p>Chưa có lịch sử xem</p>';
                return;
            }
            
            // Lọc chỉ hiển thị video (không hiển thị lịch sử tìm kiếm)
            const videoHistory = history.filter(item => item.type === 'video');
            
            if (videoHistory.length === 0) {
                videoList.innerHTML += '<p>Chưa có lịch sử xem video</p>';
                return;
            }
            
            videoHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'videoItem';
                div.innerHTML = `
                    <img src="https://i.ytimg.com/vi/${item.id}/mqdefault.jpg" alt="${item.title}" />
                    <div class="videoInfo">
                        <h4>${item.title}</h4>
                        <p>Đã xem: ${new Date(item.timestamp).toLocaleString('vi-VN')}</p>
                    </div>
                `;
                
                div.onclick = () => playVideo(item.id, item.title, '');
                videoList.appendChild(div);
            });
        }

        // Hiển thị video yêu thích
        function showFavorites() {
            const videoList = document.getElementById('videoList');
            videoList.innerHTML = '<h3 class="section-title">Video yêu thích</h3>';
            
            if (favorites.length === 0) {
                videoList.innerHTML += '<p>Chưa có video yêu thích</p>';
                return;
            }
            
            favorites.forEach(fav => {
                const div = document.createElement('div');
                div.className = 'videoItem';
                div.innerHTML = `
                    <img src="${fav.thumb}" alt="${fav.title}" />
                    <div class="videoInfo">
                        <h4>${fav.title}</h4>
                    </div>
                    <button class="favorite-btn active" onclick="toggleFavorite(event, '${fav.id}', '${fav.title.replace(/'/g, "\\'")}', '${fav.thumb}')">
                        <i class="fas fa-heart"></i>
                    </button>
                `;
                
                div.onclick = () => playVideo(fav.id, fav.title, '');
                videoList.appendChild(div);
            });
        }

        // Chuyển đổi yêu thích
        function toggleFavorite(event, videoId, title, thumb) {
            event.stopPropagation(); // Ngăn không cho kích hoạt sự kiện playVideo
            
            const index = favorites.findIndex(fav => fav.id === videoId);
            
            if (index === -1) {
                // Thêm vào yêu thích
                favorites.push({ id: videoId, title: title, thumb: thumb });
                event.currentTarget.classList.add('active');
                showToast('Đã thêm vào video yêu thích');
            } else {
                // Xóa khỏi yêu thích
                favorites.splice(index, 1);
                event.currentTarget.classList.remove('active');
                showToast('Đã xóa khỏi video yêu thích');
            }
            
            // Lưu dữ liệu
            saveUserData();
        }

        // Thêm vào yêu thích từ nút
        function addToFavorites() {
            if (!currentVideoId) {
                showToast('Vui lòng chọn một video trước', 'error');
                return;
            }
            
            const index = favorites.findIndex(fav => fav.id === currentVideoId);
            
            if (index === -1) {
                // Thêm vào yêu thích
                favorites.push({ 
                    id: currentVideoId, 
                    title: currentVideoTitle, 
                    thumb: `https://i.ytimg.com/vi/${currentVideoId}/mqdefault.jpg` 
                });
                showToast('Đã thêm vào video yêu thích');
            } else {
                // Xóa khỏi yêu thích
                favorites.splice(index, 1);
                showToast('Đã xóa khỏi video yêu thích');
            }
            
            // Lưu dữ liệu
            saveUserData();
            
            // Cập nhật nút yêu thích
            updateFavoriteButtons();
        }

        // Cập nhật nút yêu thích
        function updateFavoriteButtons() {
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                const videoId = btn.getAttribute('onclick').split("'")[1];
                if (favorites.some(fav => fav.id === videoId)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Hiển thị cài đặt
        function showSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        // Đóng modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Chuyển đổi theme
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Lưu cài đặt theme
            if (userData) {
                db.collection('users').doc(userData.uid).update({
                    'settings.theme': newTheme
                }).catch(error => {
                    console.error('Lỗi khi lưu cài đặt theme:', error);
                });
            }
        }

        // Thích video
        function likeVideo() {
            if (!currentVideoId) {
                showToast('Vui lòng chọn một video trước', 'error');
                return;
            }
            
            showToast('Đã thích video');
        }

        // Chia sẻ video
        function shareVideo() {
            if (!currentVideoId) {
                showToast('Vui lòng chọn một video trước', 'error');
                return;
            }
            
            const url = `https://www.youtube.com/watch?v=${currentVideoId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: currentVideoTitle,
                    url: url
                }).catch(error => {
                    console.error('Lỗi khi chia sẻ:', error);
                });
            } else {
                // Fallback cho trình duyệt không hỗ trợ Web Share API
                navigator.clipboard.writeText(url)
                    .then(() => {
                        showToast('Đã sao chép liên kết vào clipboard');
                    })
                    .catch(err => {
                        console.error('Không thể sao chép văn bản: ', err);
                    });
            }
        }

        // Tải video
        function downloadVideo() {
            if (!currentVideoId) {
                showToast('Vui lòng chọn một video trước', 'error');
                return;
            }
            
            showToast('Tính năng tải video sẽ sớm được cập nhật');
        }

        // Hiển thị menu người dùng
        function showUserMenu() {
            // Có thể thêm menu dropdown ở đây
            showToast(`Xin chào ${userData.displayName || userData.email}!`);
        }

        // Hiển thị thông báo
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Lưu dữ liệu định kỳ mỗi 30 giây
        setInterval(saveUserData, 30000);
        
        // Lưu dữ liệu khi rời trang
        window.addEventListener('beforeunload', saveUserData);
    </script>
</body>
</html>
